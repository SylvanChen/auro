# 读书笔记：《Java 性能权威指南》

## 知识点

### 性能测试
本文介绍了性能测试的4个原则

#### 1.测试真实应用（在实际使用的环境中进行性能测试）

> a.微基准测试：用来测试微小单元的性能，包括调用同步方法的用时与非同步方法的用时比较，创建线程的代价与使用线程池的代价，执行某种算法的的耗时与其替代实现的耗时，等等。
> 
>> 被测试代码的结果必须被使用到，不然被测试代码会被编译器优化掉，不进行运行，得不到实际测试效果
>>
>> 被测试代码中不要包含无关操作
>> 
>> 测试过程必须输入合理参数，有的参数导致O(1000)复杂度，有的参数操作只有O(1)
>>
>> 微基准测试需要热身期：Java的一个特点是代码执行的越多性能越好
> 
> b.宏基准测试：衡量应用性能最好的事物就是应用本身，以及它用到的外部资源
> 
> c.介基准测试：测试某方面性能的基准测试，但仍要执行大量代码

#### 2.理解批处理流逝时间、吞吐量和响应时间：应该测量哪个指标取决于对应应用最重要的因素

> a.批处理流逝时间：Java由于即时编译（JIT）机制中，虚拟机会花几分钟（或更长时间）全面优化代码并以最高性能执行；因此Java性能测试需要关注热身期：编译优化；缓存
> 
> b.吞吐量测试：一定时间内所能完成的工作量，TPS、RPS、OPS
> 
> c.响应时间测试：从客户端发送请求到收到响应之间的流逝时间，P95

#### 3.用统计方法应对性能变化

> a.学生t检验

#### 4.尽早频繁测试

> a.自动化一切：脚本化或程序化
> 
> b.测试一切：CPU使用率、磁盘使用率、网络使用率、内存使用率
> 
> c.在真实系统上运行

### JIT 编译
即时编译器（Just-In-Time, JIT）是Java虚拟机的核心

#### 编译器工作原理
> a.编译型语言（C++、Fortran）：程序以二进制形式交付，写完的程序被编译器静态编译成二进制文件，二进制文件中的汇编码是针对特定CPU的，只有兼容的CPU才能执行
> 
> b.解释型语言（PHP、Perl）：只要机器上有合适的解释器，相同的程序代码可以在任何CPU上运行，执行程序时，解释器会将相应代码转换成二进制代码
> 
> c.即时编译：Java应用先被编译成一种理想化的汇编语言，然后该汇编语言（Java字节码）可以用java（相当于解释器）运行

#### JIT编译器优缺点
> a.client(C1编译器)：开启编译比server要早，编译出的字节码比server多，在代码执行的开始阶段，client编译器比server编译器要快
> 
> b.server(C2编译器)：server编译器在编译代码时，比client优化得更好，生成的代码比client快
> 
> c.分层编译：代码先由client编译器编译，启动后随着代码变热，由server编译器重新编译


#### 编译器中级调优
> a.调优代码缓存：JVM编译代码时，会在代码缓存中保留编译之后的汇编语言指令集，如果缓存太小，JVM就不能编译更多代码了，导致运行耗时增加
> 
> b.编译阈值：代码执行达到一定次数，且达到了编译阈值，触发编译器编译代码，编译是基于两种JVM计数器的（方法调用计数器和方法中的循环回边计数器
> 
> c.检查汇编过程：+PrintCompilation(默认为false)

### 垃圾收集

#### 虚拟机类型(与平台的默认JVM编译器相关，决定了平台默认的垃圾收集器)
* Client 类: Windows 上运行的任何32位JVM，以及单CPU机器上运行的任何32位JVM，都是Client类虚拟机
* Server 类：其他机器都被认为是Server类

### Java 堆内存使用

### Java 本地内存使用

### 线程性能调优

### Java 企业版 API

### JPA 和 JDBC

### Java SE API 技巧